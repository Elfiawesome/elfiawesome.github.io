<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broke Sleep Schedule Japan Trip</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        :root {
            --bg-body: #0f172a;
            --bg-panel: #1e293b;
            --bg-input: #334155;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #38bdf8;
            --border: #334155;
            --header-h: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- Header --- */
        header {
            height: var(--header-h);
            background-color: rgba(15, 23, 42, 0.95);
            border-bottom: 1px solid var(--border);
            padding: 0 1.5rem;
            display: flex;
            gap: 1.5rem;
            align-items: center;
            justify-content: space-between;
            z-index: 50;
            flex-shrink: 0; /* Prevent header squishing */
        }

        .brand h1 { font-size: 1.25rem; font-weight: 600; white-space: nowrap; }
        .brand span { color: var(--text-muted); font-size: 0.85rem; margin-left: 10px; }

        .controls { display: flex; gap: 0.8rem; flex: 1; align-items: center; min-width: 0; }

        .input-group {
            background: var(--bg-input);
            border: 1px solid transparent;
            color: white;
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            font-size: 0.9rem;
            outline: none;
        }
        
        .search-wrapper { flex-grow: 1; max-width: 400px; position: relative; }
        .search-wrapper input { width: 100%; }
        select.input-group { cursor: pointer; }

        .view-toggles { display: flex; background: var(--bg-input); padding: 4px; border-radius: 6px; white-space: nowrap; }
        .toggle-btn { background: transparent; border: none; color: var(--text-muted); padding: 5px 15px; border-radius: 4px; cursor: pointer; }
        .toggle-btn.active { background-color: var(--accent); color: var(--bg-body); font-weight: 600; }

        /* --- Layout Container --- */
        .app-container {
            display: flex;
            height: calc(100vh - var(--header-h));
            width: 100%;
            overflow: hidden;
        }

        /* --- Main Content (Gallery/Map) --- */
        .main-content {
            flex-grow: 1; /* Takes remaining space */
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-width: 0; /* Fix flexbox overflow issues */
        }

        #gallery-view {
            height: 100%; overflow-y: auto; padding: 1.5rem;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem; align-content: flex-start;
        }

        #map-view { width: 100%; height: 100%; display: none; }

        /* --- Resizer Handle --- */
        #drag-handle {
            width: 5px;
            background: var(--bg-body);
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            cursor: col-resize;
            transition: background 0.2s;
            flex-shrink: 0;
            z-index: 100;
        }
        #drag-handle:hover, #drag-handle.dragging { background: var(--accent); }

        /* --- Right: Inspector Panel --- */
        .inspector {
            width: 400px; /* Default Width */
            min-width: 250px;
            max-width: 60vw;
            background: var(--bg-panel);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0; /* Prevent resizing by flexbox, handled by JS */
        }

        /* Inspector Styles */
        .inspector-header { padding: 1.5rem; border-bottom: 1px solid var(--border); }
        .inspector-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; word-break: break-all; }
        .inspector-meta { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; }
        
        .inspector-media {
            width: 100%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            min-height: 200px;
        }
        
        .inspector-media img, .inspector-media video {
            max-width: 100%;
            max-height: 50vh; /* Don't be taller than half viewport */
            display: block;
        }

        .inspector-body { padding: 1.5rem; }
        .prop-row { display: flex; justify-content: space-between; margin-bottom: 0.8rem; font-size: 0.9rem; }
        .prop-label { color: var(--text-muted); }
        .prop-value { font-weight: 500; text-align: right; margin-left: 1rem; }
        
        .empty-state {
            height: 100%; display: flex; align-items: center; justify-content: center;
            color: var(--text-muted); text-align: center; padding: 2rem;
        }

        /* --- Card Styles --- */
        .card {
            background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px;
            transition: all 0.2s; display: flex; flex-direction: column;
            cursor: pointer; 
        }
        .card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .card.selected { border: 2px solid var(--accent); }

        .media-thumb { height: 140px; width: 100%; object-fit: cover; background: #000; border-radius: 7px 7px 0 0; }
        
        .card-body { padding: 0.8rem; }
        .card-title { font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 0.25rem; }
        .card-sub { font-size: 0.75rem; color: var(--text-muted); }

        /* Map Popups */
        .popup-thumb { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; margin-bottom: 5px; }
        .leaflet-popup-content-wrapper { background: var(--bg-panel); color: white; border-radius: 6px; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 10px; width: 160px !important; }

        /* Utils */
        .badge {
            position: absolute; top: 6px; right: 6px;
            background: rgba(0,0,0,0.8); color: white;
            font-size: 0.65rem; padding: 2px 6px; border-radius: 4px;
            font-weight: 700; pointer-events: none;
        }
        .spinner {
            border: 3px solid rgba(255,255,255,0.1); border-left-color: var(--accent);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        #scroll-sentinel { grid-column: 1 / -1; height: 20px; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: var(--bg-input); }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 768px) {
            :root { --header-h: auto; }

            header {
                padding: 1rem;
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }

            .brand { display: flex; justify-content: space-between; align-items: center; }

            .app-container {
                flex-direction: column;
                height: calc(100vh - 140px); /* Approx header height correction */
            }

            /* Main view takes available height first */
            .main-content { flex: 1; }

            /* Resizer hidden on mobile (vertical stack) */
            #drag-handle { display: none; }

            /* Inspector becomes a bottom panel */
            .inspector {
                width: 100% !important;
                height: 40vh; /* Fixed height at bottom */
                min-height: 200px;
                max-width: 100%;
                border-left: none;
                border-top: 1px solid var(--border);
            }
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <h1>Japan Trip</h1>
            <span id="stats">Loading...</span>
        </div>
        
        <div class="controls">
            <div class="search-wrapper">
                <input type="text" class="input-group" id="search-input" placeholder="Search...">
            </div>

            <select id="sort-select" class="input-group" onchange="handleSort()">
                <option value="date_desc">Newest</option>
                <option value="date_asc">Oldest</option>
                <option value="name_asc">A-Z</option>
            </select>
            
            <div class="view-toggles">
                <button class="toggle-btn active" onclick="switchView('gallery')">Grid</button>
                <button class="toggle-btn" onclick="switchView('map')">Map</button>
            </div>
        </div>
    </header>

    <div class="app-container">
        <!-- Center Content -->
        <div class="main-content" id="main-content-area">
            <div id="gallery-view">
                <div id="scroll-sentinel"></div>
            </div>
            <div id="map-view"></div>
        </div>

        <!-- Resizer Handle -->
        <div id="drag-handle"></div>

        <!-- Right Inspector -->
        <aside class="inspector" id="inspector-panel">
            <div class="empty-state">
                <p>Select an asset<br>to view details.</p>
            </div>
        </aside>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>

    <script>
        const rootPath = "https://raw.githubusercontent.com/Elfiawesome/bss-jp-memory/refs/heads/main/web-source/"
        // --- State ---
        let rawData = [];
        let filteredData = [];
        let currentBatchIndex = 0;
        const BATCH_SIZE = 30;
        
        // Map Globals
        let map = null;
        let markersLayer = new L.LayerGroup();
        let currentView = 'gallery';
        let targetLocation = null;
        
        const galleryContainer = document.getElementById('gallery-view');
        const sentinel = document.getElementById('scroll-sentinel');
        const statsEl = document.getElementById('stats');
        const inspectorEl = document.getElementById('inspector-panel');

        // --- Resizer Logic ---
        const resizer = document.getElementById('drag-handle');
        const inspectorPanel = document.getElementById('inspector-panel');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('dragging');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none'; // Prevent text selection
        });

        window.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            // Calculate new width: Total Width - Mouse X Position
            const newWidth = window.innerWidth - e.clientX;
            // Apply bounds via CSS constraints (min/max-width)
            inspectorPanel.style.width = `${newWidth}px`;
            
            // If map is open, it might need updating during resize? 
            // Better to do it on mouseup for performance
        });

        window.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('dragging');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                
                // Refresh map size if it's visible
                if (map && currentView === 'map') {
                    map.invalidateSize();
                }
            }
        });

        // --- Helpers ---
        function dmsToDD(dmsArray) {
            if (!Array.isArray(dmsArray) || dmsArray.length < 3) return null;
            let [deg, min, sec, ref] = dmsArray;
            let dd = Number(deg) + (Number(min) / 60) + (Number(sec) / 3600);
            if (ref === 'S' || ref === 'W') dd = dd * -1;
            return dd;
        }

        function getAssetDate(item) {
            if (item.dt) return item.dt * 1000;
            if (item.dm) return new Date(item.dm).getTime();
            if (item.dc) return new Date(item.dc).getTime();
            return 0;
        }

        function formatUnixDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp > 10000000000 ? new Date(timestamp) : new Date(timestamp * 1000);
            return date.toLocaleString('en-US', { 
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function isVideo(filename) { return /\.(mp4|mov|webm|ogg|mkv)$/i.test(filename); }
        function isHeic(filename) { return /\.(heic|heif)$/i.test(filename); }

        function getPaths(key) {
            const cleanKey = key.replace('.json', '').replace(/\\/g, '/');
            const origPath = `assets/${cleanKey}`;
            const lastDot = cleanKey.lastIndexOf('.');
            const keyNoExt = lastDot !== -1 ? cleanKey.substring(0, lastDot) : cleanKey;
            const thumbPath = `thumbs/${keyNoExt}.jpg`;
            return { origPath, thumbPath };
        }

        // --- Initialization ---
        async function init() {
            try {
                const response = await fetch(rootPath + 'index.json');
                const json = await response.json();
                
                rawData = Object.entries(json.asset).map(([key, item]) => {
                    const lat = (item.gps && item.gps.lat) ? dmsToDD(item.gps.lat) : null;
                    const lon = (item.gps && item.gps.lon) ? dmsToDD(item.gps.lon) : null;
                    var { origPath, thumbPath } = getPaths(key);
                    origPath = rootPath + origPath;
                    thumbPath = rootPath + thumbPath;

                    return {
                        id: key,
                        origPath, 
                        thumbPath,
                        ...item,
                        computedDate: getAssetDate(item),
                        coordinates: (lat && lon) ? [lat, lon] : null
                    };
                });

                filteredData = [...rawData];
                
                initMap(); 
                handleSort(); 

                const observer = new IntersectionObserver((entries) => {
                    if (entries[0].isIntersecting) renderNextBatch();
                }, { rootMargin: '300px' });
                observer.observe(sentinel);
                
                document.getElementById('search-input').addEventListener('input', handleSearch);

            } catch (err) {
                console.error(err);
                statsEl.innerText = "Error loading data.";
            }
        }

        // --- Core Logic ---
        function handleSort() {
            const criteria = document.getElementById('sort-select').value;
            filteredData.sort((a, b) => {
                if (criteria === 'date_desc') return b.computedDate - a.computedDate;
                if (criteria === 'date_asc') return a.computedDate - b.computedDate;
                if (criteria === 'name_asc') return a.name.localeCompare(b.name);
            });
            
            renderMapMarkers();
            resetGallery();
        }

        function handleSearch(e) {
            const term = e.target.value.toLowerCase();
            filteredData = rawData.filter(item => {
                const str = `${item.name} ${item.user || ''} ${(item.tags || []).join(' ')}`.toLowerCase();
                return str.includes(term);
            });
            handleSort();
        }

        // --- Inspector Logic ---
        function selectAsset(item) {
            // 1. Highlight
            document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
            const activeCard = document.getElementById(`card-${item.id}`);
            if(activeCard) activeCard.classList.add('selected');

            // 2. Map Sync
            if (item.coordinates) {
                targetLocation = item.coordinates; 
                if (currentView === 'map' && map) {
                    map.flyTo(item.coordinates, 16);
                    markersLayer.eachLayer(layer => {
                        const latLng = layer.getLatLng();
                        if(Math.abs(latLng.lat - item.coordinates[0]) < 0.00001 && 
                           Math.abs(latLng.lng - item.coordinates[1]) < 0.00001) {
                            layer.openPopup();
                        }
                    });
                }
            } else {
                targetLocation = null;
            }

            // 3. Render Inspector
            renderInspectorContent(item);

            // 4. Mobile UX: Scroll to inspector
            if (window.innerWidth <= 768) {
                inspectorPanel.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function renderInspectorContent(item) {
            inspectorEl.innerHTML = `
                <div class="inspector-media" id="inspector-stage">
                    <div class="spinner"></div>
                </div>
                <div class="inspector-header">
                    <div class="inspector-title">${item.name}</div>
                    <div class="inspector-meta">
                        ${item.user || 'Unknown User'}<br>
                        ${formatUnixDate(item.dt)}
                    </div>
                </div>
                <div class="inspector-body">
                    <div class="prop-row"><span class="prop-label">Type</span><span class="prop-value">${getExtension(item.name)}</span></div>
                    <div class="prop-row"><span class="prop-label">Location</span><span class="prop-value">${item.coordinates ? 'GPS Available' : 'No GPS'}</span></div>
                    <div class="prop-row"><span class="prop-label">Tags</span><span class="prop-value">${(item.tags || []).join(', ')}</span></div>
                    <div style="margin-top:20px; text-align:center;">
                        <a href="${item.origPath}" download class="toggle-btn active" style="text-decoration:none; font-size:0.8rem;">Download Original</a>
                    </div>
                </div>
            `;

            const stage = document.getElementById('inspector-stage');
            
            if (isVideo(item.name)) {
                stage.innerHTML = `<video src="${item.origPath}" controls autoplay style="width:100%"></video>`;
            } 
            else if (isHeic(item.name)) {
                fetch(item.origPath)
                    .then(res => res.blob())
                    .then(blob => heic2any({ blob, toType: "image/jpeg", quality: 0.8 }))
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        stage.innerHTML = `<img src="${url}">`;
                    })
                    .catch(() => {
                        stage.innerHTML = `<div style="color:var(--text-muted); text-align:center">Preview Unavailable<br>(Use Download)</div>`;
                    });
            } 
            else {
                const img = new Image();
                img.src = item.origPath;
                img.onload = () => { stage.innerHTML = ''; stage.appendChild(img); };
                img.onerror = () => { stage.innerHTML = 'Image Load Error'; };
            }
        }

        function getExtension(filename) {
            return filename.split('.').pop().toUpperCase();
        }

        // --- Gallery Rendering ---
        function resetGallery() {
            statsEl.innerText = `${filteredData.length} Asset${filteredData.length !== 1 ? 's' : ''}`;
            galleryContainer.querySelectorAll('.card').forEach(c => c.remove());
            currentBatchIndex = 0;
            if (filteredData.length > 0) renderNextBatch();
        }

        function renderNextBatch() {
            const batch = filteredData.slice(currentBatchIndex, currentBatchIndex + BATCH_SIZE);
            if (!batch.length) return;

            const fragment = document.createDocumentFragment();
            batch.forEach(item => {
                const card = document.createElement('article');
                card.className = 'card';
                card.id = `card-${item.id}`;
                
                let badge = 'IMG';
                if(isVideo(item.name)) badge = 'VID';
                if(isHeic(item.name)) badge = 'HEIC';

                card.innerHTML = `
                    <div style="position:relative">
                        <img src="${item.thumbPath}" class="media-thumb" loading="lazy" onerror="this.src='https://placehold.co/400?text=No+Thumb'">
                        <div class="badge">${badge}</div>
                    </div>
                    <div class="card-body">
                        <div class="card-title" title="${item.name}">${item.name}</div>
                        <div class="card-sub">${formatUnixDate(item.dt)}</div>
                    </div>
                `;
                
                card.onclick = () => selectAsset(item);
                fragment.appendChild(card);
            });
            galleryContainer.insertBefore(fragment, sentinel);
            currentBatchIndex += batch.length;
        }

        // --- Map Logic ---
        function initMap() {
            map = L.map('map-view').setView([0, 0], 2);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }).addTo(map);
            //L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            //    attribution: '&copy; OpenStreetMap', subdomains: 'abcd', maxZoom: 19
            //}).addTo(map);
            markersLayer.addTo(map);
        }

        function renderMapMarkers() {
            if (!map) return;
            markersLayer.clearLayers();
            const bounds = [];

            filteredData.forEach(item => {
                if (item.coordinates) {
                    const popupContent = `
                        <div style="text-align:center; cursor:pointer">
                            <img src="${item.thumbPath}" class="popup-thumb" onerror="this.style.display='none'">
                            <div style="font-weight:bold; font-size:0.8rem; margin-bottom:2px">${item.name}</div>
                            <div style="font-size:0.7rem; color:#94a3b8">${formatUnixDate(item.dt)}</div>
                        </div>
                    `;
                    
                    const marker = L.marker(item.coordinates);
                    marker.bindPopup(popupContent);
                    marker.on('click', () => { selectAsset(item); });

                    markersLayer.addLayer(marker);
                    bounds.push(item.coordinates);
                }
            });

            if (bounds.length > 0 && currentView === 'map') {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // --- Tab Switching ---
        window.switchView = function(viewName) {
            currentView = viewName;
            const galDiv = document.getElementById('gallery-view');
            const mapDiv = document.getElementById('map-view');
            const btns = document.querySelectorAll('.toggle-btn');

            btns.forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (viewName === 'gallery') {
                galDiv.style.display = 'grid';
                mapDiv.style.display = 'none';
            } else {
                galDiv.style.display = 'none';
                mapDiv.style.display = 'block';
                
                setTimeout(() => {
                    map.invalidateSize();
                    
                    if (targetLocation) {
                        map.setView(targetLocation, 16);
                    } else {
                        const bounds = [];
                        markersLayer.eachLayer(l => bounds.push(l.getLatLng()));
                        if(bounds.length) map.fitBounds(bounds, { padding: [50, 50] });
                    }
                }, 100);
            }
        };

        // Start
        init();

    </script>
</body>
</html>